<html>
<head>
    <script src="https://code.highcharts.com/stock/highstock.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
   
</head>
<body>
    <div align="center">
        <h1> 시스템 성능 보고서 </h1>
        <h3 id="date"> 테스트 날짜: </h3>
        <div align="center">
            <table border="1px solid black" width="800px" style="border-collapse:collapse">
                <tr>
                    <th width="20%"> 시스템명</th>
                    <td style="padding-left:10px" id="system-name"></td>
                </tr>
                <tr>
                    <th> 시스템 설명 </th>
                    <td style="padding-left:10px" id="system-description"></td>
                </tr>
                <tr>
                    <th> 섹터 구분 </th>
                    <td style="padding-left:10px" id="system-sector"></td>
                </tr>
                <tr>
                    <th> 거래 상품 </th>
                    <td style="padding-left:10px" id="system-instruments"></td>
                </tr>
                <tr>
                    <th> 거래시작일 </th>
                    <td style="padding-left:10px" id="start"> </td>
                </tr>
                <tr>
                    <th> 거래종료일</th>
                    <td style="padding-left:10px" id="end"></td>
                </tr>
                <tr>
                    <th> 투자 원금</th>
                    <td style="padding-left:10px" id="principal"> </td>
                </tr>
                <tr>
                    <th> Heat System </th>
                    <td style="padding-left:10px" id="heat"></td>
                </tr>
                <tr>
                    <th> Max system heat </th>
                    <td style="padding-left:10px" id="max-system-heat"></td>
                </tr>
                <tr>
                    <th> Max sector heat </th>
                    <td style="padding-left:10px" id="max-sector-heat"></td>
                </tr>
                <tr>
                    <th> Max trade heat </th>
                    <td style="padding-left:10px" id="max-trade-heat"></td>
                </tr>
                <tr>
                    <th> 매매당 최대 계약수 </th>
                    <td style="padding-left:10px" id="max-lots"></td>
                </tr>
                <tr>
                    <th> 수수료 </th>
                    <td style="padding-left:10px" id="commission"></td>
                </tr>
                <tr>
                    <th> skid </th>
                    <td style="padding-left:10px" id="skid"></td>
                </tr>
                <tr>
                    <th> 사용지표 </th>
                    <td style="padding-left:10px;white-space: pre-line;" id="metrics"></td>
                </tr>
                <tr>
                    <th rowspan="2"> 진입 시그널 </th>
                    <td style="padding-left:10px" id="entry-rule-long"> LONG|</td>
                </tr>
                <tr>
                    <td style="padding-left:10px" id="entry-rule-short"> SHORT| </td>
                </tr>
                <tr>
                    <th rowspan="2"> 청산 시그널 </th>
                    <td style="padding-left:10px" id="exit-rule-long"> LONG| </td>
                </tr>
                <tr>
                    <td style="padding-left:10px" id="exit-rule-short"> SHORT| </td>
                </tr>
                <tr>
                    <th rowspan="2"> STOP 시그널 </th>
                    <td style="padding-left:10px" id="stop-rule-long"> LONG| </td>
                </tr>
                <tr>
                    <td style="padding-left:10px" id="stop-rule-short"> SHORT| </td>
                </tr>
            </table><br><br>
        </div>
    </div>
    <div align="center">
        <h2> 1. 종합 결과 </h2>
        <figure class="highcharts-figure" style="width:1000px;">
            <div id="performance-chart"></div>
        </figure>
        <div align="center">
            <table border="1" width="900px" style="border-collapse:collapse" >
                <tr align="center">
                    <th width="16.6%">최종자산</th>
                    <th width="16.6%">총손익</th>
                    <th width="16.6%">수익률</th>
                    <th width="16.6%">Bliss</th>
                    <th width="16.6%">CAGR</th>
                    <th width="16.6%">MDD</th>
                </tr>
                <tr align="center">
                    <td id="capital">$ </td>
                    <td id="profit">$ </td>
                    <td id="profit-rate"></td>
                    <td id="bliss"></td>
                    <td id="cagr"></td>
                    <td id="mdd"></td>
                </tr>
            </table>
            <br>
            <table border="1" width="900px" style="border-collapse:collapse">
                <tr align="center">
                    <th width="14.3%">승률</th>
                    <th width="14.3%">손익비</th>
                    <th width="14.3%">위험대비손익</th>
                    <th width="14.3%">수익평균</th>
                    <th width="14.3%">손실평균</th>
                    <th width="14.3%">보유기간</th>
                    <th width="14.3%">매매횟수</th>
                </tr>
                <tr align="center">
                    <td id="winrate"></td>
                    <td id="avg-ptl"></td>
                    <td id="profit-to-risk"></td>
                    <td id="avg-win"></td>
                    <td id="avg-lose"></td>
                    <td id="duration"></td>
                    <td id="num-trades"></td>
                </tr>
            </table>
        </div>
    </div>
    <div align="center" style="margin-top:100px">
        <h2> 2. 섹터별 결과 </h2>
        <div align="center">
            <table border="1" width="900px" style="border-collapse:collapse" id="sector-result">
                <tr align="center">
                    <th width="14.3%">섹터</th>
                    <th width="14.3%">총손익</th>
                    <th width="14.3%">평균손익</th>
                    <th width="14.3%">위험대비손익</th>
                    <th width="14.3%">승률</th>
                    <th width="14.3%">보유기간</th>
                    <th width="14.3%">매매횟수</th>
                </tr>
            </table>
      </div>
    </div>
    <div align="center" id="sector-detail">
        <figure class="highcharts-figure" style="width:1000px;">
            <div id="sector-chart"></div>
        </figure>
    </div>

    <div align="center" style="margin-top:100px">
        <h2> 3. 상품별 결과 </h2>
        <div align="center">
            <table border="1" width="900px" style="border-collapse:collapse" id="product-result">
                <tr align="center">
                    <th width="14.3%">상품명</th>
                    <th width="14.3%">총손익</th>
                    <th width="14.3%">평균손익</th>
                    <th width="14.3%">위험대비손익</th>
                    <th width="14.3%">승률</th>
                    <th width="14.3%">보유기간</th>
                    <th width="14.3%">매매횟수</th>
                </tr>
            </table>
        </div>
    </div>
    <div align="center" id="product-detail">
    </div>

</body>

<!-- 데이터 로드-->
<script src="data.txt" type="text/javascript"></script>
<!-- 1. 시스템 개요-->
<script>
const system_info = data.system_info
document.getElementById("date").textContent += system_info.today;
document.getElementById("system-name").textContent += system_info.name;
document.getElementById("system-description").textContent += system_info.description;
document.getElementById("system-sector").textContent += system_info.sector;
document.getElementById("system-instruments").textContent += system_info.instruments;
document.getElementById("start").textContent += system_info.start;
document.getElementById("end").textContent += system_info.end;
document.getElementById("principal").textContent += system_info.principal;
document.getElementById("heat").textContent += system_info.heat_system;
document.getElementById("max-system-heat").textContent += system_info.max_system_heat;
document.getElementById("max-sector-heat").textContent += system_info.max_sector_heat;
document.getElementById("max-trade-heat").textContent += system_info.max_trade_heat;
document.getElementById("max-lots").textContent += system_info.max_lots;
document.getElementById("commission").textContent += system_info.commission;
document.getElementById("skid").textContent += system_info.skid;
document.getElementById("metrics").textContent += system_info.metrics;
document.getElementById("entry-rule-long").textContent += system_info.entry_rule.long;
document.getElementById("entry-rule-short").textContent += system_info.entry_rule.short;
document.getElementById("exit-rule-long").textContent += system_info.exit_rule.long;
document.getElementById("exit-rule-short").textContent += system_info.exit_rule.short;
document.getElementById("stop-rule-long").textContent += system_info.stop_rule.long;
document.getElementById("stop-rule-short").textContent += system_info.stop_rule.short;
</script>

<!-- 2. 성능 보고서 -->
<script>
const performance = data.performance;
document.getElementById("capital").textContent += performance.capital.toFixed(0);
document.getElementById("profit").textContent += performance.profit.toFixed(0);
document.getElementById("profit-rate").textContent += performance.profit_rate.toFixed(2);
document.getElementById("bliss").textContent += performance.capital.toFixed(2);
document.getElementById("cagr").textContent += performance.cagr.toFixed(2);
document.getElementById("mdd").textContent += performance.mdd.toFixed(2)+' %';
document.getElementById("winrate").textContent += performance.winrate.toFixed(2);
document.getElementById("avg-ptl").textContent += performance.avg_ptl.toFixed(2);
document.getElementById("profit-to-risk").textContent += performance.profit_to_risk.toFixed(2);
document.getElementById("avg-win").textContent += performance.avg_win.toFixed(0);
document.getElementById("avg-lose").textContent += performance.avg_lose.toFixed(0);
document.getElementById("duration").textContent += performance.duration.toFixed(0);
document.getElementById("num-trades").textContent += performance.num_trades.toFixed(0);



const chartdata  =  data.performance.chartdata//JSON.parse(JSON.stringify(performance_data));
Highcharts.chart('performance-chart', {
        chart: {
            height: 600,
            zoomType: 'x',
            zooming: {
                    mouseWheel: false
                }
        },
        title: {
            text: '',
            align: 'center'
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            opposite: true,
            title: {
                text: 'Value'
            }
        },
        legend: {
            enabled: true
        },
        tooltip: {
            shared: true,
            split: false,
            enabled: false,
        },
        plotOptions: {
            line: {
               marker: {
                enabled: false
             }
            },
            area: {
                marker: {
                    enabled: false
                },
                threshold: data.system_info.principal
            }
        },

        series: [{
            
            name: '총자산',
            data: chartdata.total_value,
            type: 'line',
            color: '#46309c',
            zIndex: 100,
            enableMouseTracking: false

        },{
            type: 'area',
            name: '확정자산',
            data: chartdata.defined_value_p,
            lineWidth:0,
            color: 'green',
            opacity: 0.4,
            enableMouseTracking: false

        },{
            type: 'area',
            name: '확정자산2',
            data: chartdata.defined_value_n,
            lineWidth:0,
            color: 'red',
            opacity: 0.6,
            showInLegend: false, 
            enableMouseTracking: false

        },{
            name: '최대값',
            data: chartdata.max_value,
            type: 'line',
            color: '#eb8934',
            lineWidth: 0.8,
            enableMouseTracking: false
        },{
            name: '현금',
            data: chartdata.cash,
            type: 'line',
            color: '#252429',
            lineWidth: 0.8,
            enableMouseTracking: false
        },
        {
            name: 'reference(10%)',
            data: chartdata.reference,
            type: 'line',
            dashStyle: 'longdash',
            color: 'magenta',
            lineWidth: 0.8,
            enableMouseTracking: false
        }]
    });
</script>

<!-- 3. 섹터 보고서 -->
<script>
    const sectors = data.sector_result;
    var tbl = document.getElementById("sector-result");
    for (sector of sectors){
        var row = tbl.insertRow(); //테이블 행 추가
        row.align = "center";
        row.innerHTML = `
            <td>${sector.name}</button></td>
            <td>$ ${sector.profit.toFixed(0)}</td>
            <td>$ ${sector.avg_profit.toFixed(0)}</td>
            <td>${sector.profit_to_risk.toFixed(0)}</td>
            <td>${sector.winrate.toFixed(2)} %</td>
            <td>${sector.duration.toFixed(0)}</td>
            <td>${sector.num_trades.toFixed(0)}</td>
        `
    };

const sector_detail  =  data.sector_detail//JSON.parse(JSON.stringify(performance_data));
var sector_chart = Highcharts.chart('sector-chart', {
        chart: {
            height: 400,
            zoomType: 'x',
            zooming: {
                    mouseWheel: false
                }
        },
        title: {
            text: '',
            align: 'center'
        },
        xAxis: {
            type: 'datetime'
        },
        yAxis: {
            opposite: true,
            title: {
                text: 'Value'
            }
        },
        legend: {
            enabled: true
        },
        colors: ['#32a852','#9e7116', '#7d197a','#586ba3','#660719','#d6c313'],
    });

    for (sector of sector_detail){
        sector_chart.addSeries({
            type: 'line',                      
            name: sector.sector,
            data: sector.chartdata,
            lineWidth: 1.5,
            enableMouseTracking: false
            
        }, false);
    }
    sector_chart.redraw();

</script>

<!-- 4. 상품 보고서 -->
<script>
    const products = data.product_result;
    var tbl = document.getElementById("product-result");
    for (product of products){
        var row = tbl.insertRow(); //테이블 행 추가
        row.align = "center";
        row.innerHTML = `
            <td><button onclick="showDetail('${product.symbol}')" style='width:100%';>${product.name}</button></td>
            <td>$ ${product.profit.toFixed(0)}</td>
            <td>$ ${product.avg_profit.toFixed(0)}</td>
            <td>${product.profit_to_risk.toFixed(2)} %</td>
            <td>${product.winrate.toFixed(2)} %</td>
            <td>${product.duration.toFixed(0)}</td>
            <td>${product.num_trades.toFixed(0)}</td>
        `
    };

function showDetail(symbol){
    var parent = document.getElementById("product-detail");
    
    // 기존 dom 제거 
    var script = document.getElementById("product-chart-data");
    if (script) script.remove();

    var chart = document.getElementById("product-chart")
    if (chart) chart.remove();
    
    script = document.createElement("script");
    script.id = 'product-chart-data';
    script.type = 'text/javascript';
    script.src = `product_data(${symbol}).txt`;
    parent.appendChild(script);

    var figure = document.createElement("figure")
    figure.style.width = '1000px';
    var div = document.createElement("div")
    div.id = 'product-chart';
    figure.appendChild(div);
    parent.appendChild(figure);

    script.onload = () => {

        let trade_data = product_data.chartdata;
        var product_chart = Highcharts.stockChart('product-chart', {
                chart: {
                    height: 600,
                    zoomType: 'x',
                    zooming: {
                        mouseWheel: false
                    }
                },
                title: {
                    text: product_data.name
                },
                legend: {
                    enabled: true
                },
                colors: ['#32a852','#9e7116', '#7d197a','#586ba3','#660719','#d6c313'],
                yAxis: [{
                        id: 'ohlc',
                        opposite: false,
                        title: {
                            text: 'OHLC',
                        },
                        height: 471,
                        offset:0
                    }],
                
                rangeSelector: {
                        selected: 1,
                        enabled:false
                },
                navigator: { enabled: false	},
                scrollbar: { enabled: false },
                plotOptions: {
                    line:{
                        lineWidth:1,
                        states:{
                            hover:{
                                enabled:false
                            }
                        }
                    },
                    series: {
                        states: {
                            inactive: { opacity: 1 },
                        }
                    }
                },
                tooltip: {
                    positioner: function() {
                        return {
                            x: this.chart.plotLeft,
                            y: this.chart.plotTop
                        };
                    },
                    //shared: true,
                    //pointFormat: '{series.name}: <b>{point.y}</b><br/>',
                    valueDecimals: 2,
                    shadow: false,
                    borderWidth: 0,
                    backgroundColor: 'rgba(255,255,255,0.8)'
                },

                series: [{
                    type: 'ohlc',
                    name: 'win',
                    data: trade_data.wins,
                    yAxis: 'ohlc',
                    color: 'red',
                    showInLegend: false, 
                    states: { hover: { enabled: false } }, 
                },{
                    type: 'ohlc',
                    name: 'lose',
                    data: trade_data.loses,
                    yAxis: 'ohlc',
                    color: 'blue',
                    showInLegend: false, 
                    states: { hover: { enabled: false } },
                },{
                    type: 'ohlc',
                    name: 'neutral',
                    data: trade_data.neutrals,
                    yAxis: 'ohlc',
                    color: 'black',
                    showInLegend: false, 
                    states: { hover: { enabled: false } },
                }]
            });

        // ohlc 차트와 함께 나타낼 지표 그리기
        for (metric of trade_data.metrics_with_ohlc){
            product_chart.addSeries({  
                type: 'line',                      
                name: metric.name,
                data: metric.data,
                yAxis: 'ohlc',
                lineWidth: 0.8
            }, false);
        };
        // 별도 axis에 나타낼 지표 그리기
        let metrics = trade_data.metrics_separated;
        let chartheight = product_chart.chartHeight;
        let top = 500; //차트 포지션 용
        const height = 100;
        if (metrics){
            for (i=0; i<metrics.length; i++){
                chartheight += height;
                
                let metric = metrics[i];
                product_chart.setSize(undefined, chartheight);
                product_chart.addAxis({
                        id:metric.name,
                        opposite:false,
                        title: { 
                            text: metric.name,
                        },
                        top: top,
                        height: height,
                        offset:0,
                    
                });
                product_chart.addSeries({
                    type: 'line',                      
                    name: metric.name,
                    data: metric.data,
                    yAxis: metric.name,
                    lineWidth: 1.2
                }, false);
                top += height;
            };
        };
        //누적수익 차트 그리기
        let cum_profit = trade_data.cum_profit;
        chartheight += height;
        product_chart.setSize(undefined, chartheight);
        product_chart.addAxis({
            id:'cum_profit',
            opposite:false,
            title: { 
                text: 'Cum. Profit',
            },
            top: top,
            height: height,
            offset:0,
        
        });
        product_chart.addSeries({
                    type: 'line',                      
                    name: 'cummulative profit',
                    data: cum_profit,
                    yAxis: 'cum_profit',
                    lineWidth: 1.2,
                    color: 'blue'
                }, false);
        //개별수익 차트 그리기
        let win_profit = trade_data.win_profit;
        let lose_profit = trade_data.lose_profit;
        
        chartheight += height;
        top += height;
        product_chart.setSize(undefined, chartheight);
        product_chart.addAxis({
            id:'profit',
            opposite:false,
            title: { 
                text: 'Profit',
            },
            top: top,
            height: height,
            offset:0,
        
        });
        product_chart.addSeries({
                    type: 'column',                      
                    name: 'loses',
                    data: win_profit,
                    yAxis: 'profit',
                    color: 'red',
                    showInLegend: false, 
                    states: { hover: { enabled: false } },
                }, false);
        product_chart.addSeries({
            type: 'column',                      
            name: 'wins',
            data: lose_profit,
            yAxis: 'profit',
            color: 'blue',
            showInLegend: false, 
            states: { hover: { enabled: false } },
        }, false);
            
            product_chart.redraw();
    };
        
};

</script>
</html>